<!--
Copyright (c) 2016 Noah Freed 
Chat code based on an assignment by Simon Niklaus
-->
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0" />

		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>

		<script type="text/javascript" src="http://localhost:8080/socket.io/socket.io.js"></script>

		<script type="text/javascript"src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/3.0.11/pixi.min.js"></script>

		<style>
		  body {
		    padding: 0;
		    margin: 0;
		    background-color:#0F0E0C;
		    color:white;
		  }
		  .center {
		    text-align: center;
		  }
		  .floatl {
		    float:left;
		  }
		  .sidebar {
		    padding-left: 10px;
		    padding-right: 10px;
		  }
		</style>
	</head>
	<body>
		<div id="status" class="floatl center sidebar">
			<h1>Shoku Online</h1>
			<h3>Current Player</h3>
			<h2 id="player">None</h2>
			<h3>Current Step</h3>
			<h2 id="step">Deploy</h2>
			<input id="endturn" type="button" value="Fortify and end turn">
		</div>
		<canvas id="board" class="floatl"></canvas>
		<div id="chat" class="floatl sidebar">
			<h3>Chat</h3>
			<input id="message" type="text" placeholder="message">
			<input id="submit" type="button" value="submit">
			<br>
			<pre id="output"></pre>
		</div>

		<script type="text/javascript">
			var pixiRenderer = PIXI.autoDetectRenderer(1652, 1282, {
				'view': document.getElementById('board'),      
				'backgroundColor': 0x0F0E0C
			});
			var pixiStage = new PIXI.Container();
			var pixiBoard = new PIXI.Sprite(PIXI.Texture.fromImage('res/SunBoard.png'));      
			var sa = new PIXI.Sprite(PIXI.Texture.fromImage('res/SunArcher.png'));      
			var sh = new PIXI.Sprite(PIXI.Texture.fromImage('res/SunHorseman.png'));      
			var ss = new PIXI.Sprite(PIXI.Texture.fromImage('res/SunShieldbearer.png'));      
			var sw = new PIXI.Sprite(PIXI.Texture.fromImage('res/SunWarrior.png'));      
			var spiritTrackMarker = new PIXI.Sprite(PIXI.Texture.fromImage('res/SpiritTrackMarker.png'));
			pixiStage.addChild(pixiBoard);
			pixiStage.addChild(sa);
			sa.position.x = 625;
			sa.position.y = 1170;
			pixiStage.addChild(sh);
			sh.position.x = 775;
			sh.position.y = 1170;
			pixiStage.addChild(ss);
			ss.position.x = 1075;
			ss.position.y = 1170;
			pixiStage.addChild(sw);
			sw.position.x = 1225;
			sw.position.y = 1170;
			pixiStage.addChild(spiritTrackMarker);
			spiritTrackMarker.position.x = 195;
			spiritTrackMarker.position.y = 581;
			pixiBoard.interactive = true;
			sa.interactive = true;
			sh.interactive = true;
			ss.interactive = true;
			sw.interactive = true;
			spiritTrackMarker.interactive = true;

			//The following mousedown detection code is based on code found at http://www.html5gamedevs.com/topic/14343-how-to-get-mouse-position-in-every-frame-in-v3/
			pixiBoard.on('mousedown', mouseDownCallback);
			function mouseDownCallback(mouseData) {  
				console.log("X = "+mouseData.data.getLocalPosition(pixiBoard).x);  
				console.log("Y = "+mouseData.data.getLocalPosition(pixiBoard).y);
				getHexagon(mouseData.data.getLocalPosition(pixiBoard).x, mouseData.data.getLocalPosition(pixiBoard).y);
			}

			//Identify the tile clicked
			function getHexagon(x, y) {
				var minDist = 9999;
				var hex = {};
				hex.X = -2;
				hex.Y = -2;
				for (var i = -1; i < 8; i+=1) {
					for (var j = -1; j < 8; j+=1) {
						var distance = Math.sqrt(Math.pow((572.5 + i * 136 - x), 2) + Math.pow((182 + j * 157 + (i+1)%2*78.5 - y), 2))
						if (distance < minDist) {
							hex.X = i;
							hex.Y = j;
							minDist = distance;
						}
					}
				}
				console.log("Clicked " + minDist + " pixels away in " + hex.X + ", " + hex.Y);
				return hex;
			}

			//Push the spirit track market when clicked
			spiritTrackMarker.on('mousedown', pushSTM);
			function pushSTM(data) {
				console.log("Push the STM");
			}

			//Continuously draw the game
			(function functionGameloop() {        
				pixiRenderer.render(pixiStage);        
				window.requestAnimationFrame(functionGameloop);      
			})();

			//The following resizing code is based on code found at http://stackoverflow.com/questions/30554533/dynamically-resize-the-pixi-stage-and-its-contents-on-window-resize-and-window 
			var ratio = 1652/1282;
			resize();
			function resize() {
				var sidebarW = document.getElementById("status").offsetWidth + document.getElementById("chat").offsetWidth + 1;
				var availW = window.innerWidth - sidebarW;
				if (availW < document.getElementById("status").offsetWidth) {
					availW = document.getElementById("status").offsetWidth;
				}
				if (availW < 290) {
					availW = 290;
				}
			    if (availW / window.innerHeight >= ratio) {
				var w = window.innerHeight * ratio;
				var h = window.innerHeight;
			    } else {
				var w = availW;
				var h = availW / ratio;
			    }
			    pixiRenderer.view.style.width = w + 'px';
			    pixiRenderer.view.style.height = h + 'px';
			}
			window.onresize = resize;  

			//Communication with the server
			var socketHandle = io.connect('http://localhost:8080/');

			var strIdent = '';

			socketHandle.on('hello', function(data) {
				strIdent = data.id;
			});

			//Chat
			socketHandle.on('message', function(data) {
				jQuery('#output')
					.prepend(data.from + ': ' + data.message + '\n')
				;
			});

			jQuery('#submit')
				.on('click', function() {
					socketHandle.emit('message', {
						'to': 'everyone',
						'message': jQuery('#message').val()
					});
				})
			;
		</script>
	</body>
</html>
