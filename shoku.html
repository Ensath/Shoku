<!--Copyright (c) 2016 Noah Freed 
Chat code based on an assignment by Simon Niklaus
Additional code used from http://stackoverflow.com/questions/6169666/how-to-resize-an-image-to-fit-in-the-browser-window-->
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0" />

		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>

		<script type="text/javascript" src="http://localhost:8080/socket.io/socket.io.js"></script>

		<script type="text/javascript"src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/3.0.11/pixi.min.js"></script>

		<style>
		  body {
		    padding: 0;
		    margin: 0;
		    background-color:#0F0E0C;
		    color:white;
		  }
		  canvas {
		    max-width: 100%;
		    max-height: 100%;
		  }
		  .center {
		    text-align: center;
		  }
		  .floatl {
		    float:left;
		  }
		  .sidebar {
		    padding-left: 10px;
		    padding-right: 10px;
		  }
		</style>
	</head>
	<body>
		<div id="status" class="floatl center sidebar">
			<h1>Shoku Online</h1>
			<h3>Current Player</h3>
			<h2 id="player">None</h2>
			<h3>Current Step</h3>
			<h2 id="step">Deploy</h2>
			<input id="endturn" type="button" value="Fortify and end turn">
		</div>
		<canvas id="board" class="floatl"></canvas>
		<div id="chat" class="floatl sidebar">
			<h3>Chat</h3>
			<input id="message" type="text" placeholder="message">
			<input id="submit" type="button" value="submit">
			<br>
			<pre id="output"></pre>
		</div>

		<script type="text/javascript">
			var pixiRenderer = PIXI.autoDetectRenderer(1652, 1282, {
				'view': document.getElementById('board'),      
				'backgroundColor': 0x0F0E0C
			});
			var pixiStage = new PIXI.Container();
			var pixiBoard = new PIXI.Sprite(PIXI.Texture.fromImage('res/SunBoard.png'));      
			var sa = new PIXI.Sprite(PIXI.Texture.fromImage('res/SunArcher.png'));      
			var sh = new PIXI.Sprite(PIXI.Texture.fromImage('res/SunHorseman.png'));      
			var ss = new PIXI.Sprite(PIXI.Texture.fromImage('res/SunShieldbearer.png'));      
			var sw = new PIXI.Sprite(PIXI.Texture.fromImage('res/SunWarrior.png'));      
			var spiritTrackMarker = new PIXI.Sprite(PIXI.Texture.fromImage('res/SpiritTrackMarker.png'));
			pixiStage.addChild(pixiBoard);
			pixiStage.addChild(sa);
			sa.position.x = 625;
			sa.position.y = 1170;
			pixiStage.addChild(sh);
			sh.position.x = 775;
			sh.position.y = 1170;
			pixiStage.addChild(ss);
			ss.position.x = 1075;
			ss.position.y = 1170;
			pixiStage.addChild(sw);
			sw.position.x = 1225;
			sw.position.y = 1170;
			pixiStage.addChild(spiritTrackMarker);
			spiritTrackMarker.position.x = 195;
			spiritTrackMarker.position.y = 581;
			pixiBoard.interactive = true;

			//The following mousedown detection code is based on code found at http://www.html5gamedevs.com/topic/14343-how-to-get-mouse-position-in-every-frame-in-v3/
			pixiBoard.on('mousedown', mouseDownCallback);
			function mouseDownCallback(mouseData) {  
				console.log("X = "+mouseData.data.getLocalPosition(pixiBoard).x);  
				console.log("Y = "+mouseData.data.getLocalPosition(pixiBoard).y);
			}

			(function functionGameloop() {        
				pixiRenderer.render(pixiStage);        
				window.requestAnimationFrame(functionGameloop);      
			})();

			//The following resizing code is based on code found at http://stackoverflow.com/questions/30554533/dynamically-resize-the-pixi-stage-and-its-contents-on-window-resize-and-window 
			var ratio = 1652/1282;
			resize();
			function resize() {
				var sidebarW = document.getElementById("status").offsetWidth + document.getElementById("chat").offsetWidth + 1;
				var availW = window.innerWidth - sidebarW;
				if (availW < document.getElementById("status").offsetWidth) {
					availW = document.getElementById("status").offsetWidth;
				}
				if (availW < 290) {
					availW = 290;
				}
			    if (availW / window.innerHeight >= ratio) {
				var w = window.innerHeight * ratio;
				var h = window.innerHeight;
			    } else {
				var w = availW;
				var h = availW / ratio;
			    }
			    pixiRenderer.view.style.width = w + 'px';
			    pixiRenderer.view.style.height = h + 'px';
			}
			window.onresize = resize;  

			var socketHandle = io.connect('http://localhost:8080/');

			var strIdent = '';

			socketHandle.on('hello', function(data) {
				strIdent = data.id;
			});

			socketHandle.on('message', function(data) {
				jQuery('#output')
					.prepend(data.from + ': ' + data.message + '\n')
				;
			});

			jQuery('#submit')
				.on('click', function() {
					socketHandle.emit('message', {
						'to': 'everyone',
						'message': jQuery('#message').val()
					});
				})
			;
		</script>
	</body>
</html>
